#!/usr/bin/env node
var bt=Object.defineProperty;var a=(e,t)=>bt(e,"name",{value:t,configurable:!0});var xt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);import{jsx as f,jsxs as L}from"react/jsx-runtime";import{alert as g,ConfigPanel as Tt,useTheme as vt,SplitView as Ct,render as I}from"@lobehub/cli-ui";import{Command as Ot,Option as j}from"commander";import Nt from"update-notifier";import Mt from"conf";import{cosmiconfigSync as Ft}from"cosmiconfig";import{TextInput as V,Spinner as Lt,ProgressBar as It,StatusMessage as jt}from"@inkjs/ui";import{memo as Q,useState as At,useMemo as Et}from"react";import u from"chalk";import $t from"dotenv";import{merge as N,sumBy as Jt,isPlainObject as z,cloneDeep as Pt,unset as Rt,set as Ut,reduce as Bt,isString as Dt}from"lodash-es";import{consola as p}from"consola";import{resolve as y,dirname as _t,join as W,relative as A}from"node:path";import{Text as x,Box as Kt}from"ink";import Y from"p-map";import{RecursiveCharacterTextSplitter as qt}from"langchain/text_splitter";import{encode as X}from"gpt-tokenizer";import H from"remark-frontmatter";import Z from"remark-gfm";import Gt from"remark-parse";import Vt from"remark-stringify";import{unified as tt}from"unified";import{visit as et}from"unist-util-visit";import{diff as Qt}from"just-diff";import{ChatOpenAI as zt}from"@langchain/openai";import{ChatPromptTemplate as nt}from"@langchain/core/prompts";import{writeFileSync as ot,readFileSync as rt,existsSync as T,mkdirSync as st}from"node:fs";import Wt from"json-stable-stringify";import{globSync as it}from"glob";import*as Yt from"node:process";import at from"gray-matter";var He=xt((q,G)=>{var Xt="@lobehub/i18n-cli",Ht="1.19.1",Zt="Lobe i18n is a CLI tool that automate translate your i18n localization with AI",te=["ai","i18n","openai","gpt","langchain"],ee="https://github.comlobehub/lobe-cli-toolbox/tree/master/packages/lobe-i18n",ne={url:"https://github.com/lobehub/lobe-cli-toolbox/issues/new"},oe={type:"git",url:"https://github.com/lobehub/lobe-cli-toolbox.git"},re="MIT",se="LobeHub <i@lobehub.com>",ie=!1,ae="module",ce={"@":"./src"},q={require:{types:"./dist/index.d.cts",default:"./dist/index.cjs"},import:{types:"./dist/index.d.mts",default:"./dist/index.mjs"}},le="./dist/index.cjs",G="./dist/index.mjs",ue="./dist/index.d.cts",pe={"lobe-i18n":"dist/cli.js"},fe=["dist"],me={build:"npm run type-check && pkgroll --minify -p tsconfig.prod.json --env.NODE_ENV=production && npm run shebang",dev:"pkgroll -p tsconfig.prod.json --env.NODE_ENV=development --watch",link:"npm run build && npm link -f",shebang:"lobe-shebang -t ./dist/cli.js",start:"node ./dist/cli.js",test:"vitest --passWithNoTests","test:coverage":"vitest run --coverage --passWithNoTests","type-check":"tsc --noEmit"},de={"@inkjs/ui":"^1.0.0","@langchain/core":"^0.2.20","@langchain/openai":"^0.2.5","@lobehub/cli-ui":"1.10.0",chalk:"^5.3.0",commander:"^12.1.0",conf:"^12.0.0",consola:"^3.2.3",cosmiconfig:"^9.0.0",dotenv:"^16.4.5","fast-deep-equal":"^3.1.3",glob:"^10.4.5","gpt-tokenizer":"^2.2.1","gray-matter":"^4.0.3",ink:"^4.4.1","json-stable-stringify":"^1.1.1","just-diff":"^6.0.2",langchain:"^0.2.12","lodash-es":"^4.17.21","p-map":"^7.0.2",pangu:"^4.0.7",react:"^18.3.1","remark-frontmatter":"^4.0.1","remark-gfm":"^3.0.1","remark-parse":"^10.0.2","remark-stringify":"^10.0.3",swr:"^2.2.5",unified:"^11.0.5","unist-util-visit":"^5.0.0","update-notifier":"^7.2.0",zustand:"^4.5.4"},ge={"@types/json-stable-stringify":"^1.0.36"},he={ink:">=4",react:">=18"},ye={node:">=18"},ke={access:"public",registry:"https://registry.npmjs.org/"},E={name:Xt,version:Ht,description:Zt,keywords:te,homepage:ee,bugs:ne,repository:oe,license:re,author:se,sideEffects:ie,type:ae,imports:ce,exports:q,main:le,module:G,types:ue,bin:pe,files:fe,scripts:me,dependencies:de,devDependencies:ge,peerDependencies:he,engines:ye,publishConfig:ke},v=(e=>(e.MDAST="mdast",e.STRING="string",e))(v||{});const $=a(e=>`.${e}.md`,"getDefaultExtension"),we={"gpt-3.5-turbo":16385,"gpt-3.5-turbo-0125":16385,"gpt-3.5-turbo-1106":16385,"gpt-3.5-turbo-16k":16385,"gpt-4":8192,"gpt-4-0613":8192,"gpt-4-32k":32768,"gpt-4-0125-preview":128e3,"gpt-4-vision-preview":128e3,"gpt-4-turbo":128e3,"gpt-4-turbo-vision":128e3,"gpt-4-turbo-preview":128e3,"gpt-4-1106-vision-preview":128e3,"gpt-4-1106-preview":128e3,"gpt-4o-2024-05-13":128e3,"gpt-4o-mini":16385},ct="gpt-4o-mini",Se={concurrency:5,markdown:{entry:[],mode:v.STRING,outputExtensions:$},modelName:ct,temperature:0},k=a((e,t)=>{e[t]||g.error(`Can't find ${u.bold.yellow("outputLocales")} in config`)},"checkOptionKeys"),lt={apiBaseUrl:{default:"",type:"string"},openaiToken:{default:"",type:"string"}},J=new Mt({projectName:"lobe-i18n",schema:lt});class be{static{a(this,"ExplorerConfig")}explorer;customConfig;constructor(){this.explorer=Ft("i18n")}loadCustomConfig(t){this.customConfig=t}getConfigFile(){return this.customConfig?this.explorer.load(this.customConfig)?.config:this.explorer.search()?.config}}const P=new be;$t.config();const R=a(e=>J.get(e),"getConfig"),xe=a(e=>lt[e].default,"getDefulatConfig"),Te=a((e,t)=>J.set(e,t),"setConfig"),ve=a(()=>process.env.OPENAI_API_KEY||R("openaiToken"),"getOpenAIApiKey"),Ce=a(()=>process.env.OPENAI_PROXY_URL||R("apiBaseUrl"),"getOpenAIProxyUrl"),U=a(()=>{const e=P.getConfigFile();return e?N(Se,e):g.error(`Can't find ${u.bold.yellow("config")}`,!0)},"getConfigFile"),Oe=a(()=>{const e=U();return k(e,"entry"),k(e,"entryLocale"),k(e,"output"),k(e,"outputLocales"),e},"getLocaleConfig"),Ne=a(()=>{const e=U();if(!e.markdown)return g.error(`Can't find ${u.bold.yellow("config.markdown")}`,!0);const t=N(e?.markdown||{},{entryLocale:e?.markdown?.entryLocale||e.entryLocale,outputLocales:e?.markdown?.outputLocales||e.outputLocales});return k(t,"entry"),k(t,"entryLocale"),k(t,"outputLocales"),t},"getMarkdownConfigFile");var d={getConfig:R,getConfigFile:U,getDefulatConfig:xe,getLocaleConfig:Oe,getMarkdownConfigFile:Ne,getOpenAIApiKey:ve,getOpenAIProxyUrl:Ce,setConfig:Te};const Me=a(()=>{const e=J.store;return{get:d.getConfig,getDefault:d.getDefulatConfig,set:d.setConfig,store:e}},"useConfStore"),Fe=Q(()=>{const[e,t]=At(),{store:n,set:o,getDefault:r}=Me(),i=a((c,l)=>{o(c,l),t("")},"setConfig"),s=Et(()=>[{children:f(V,{defaultValue:n.openaiToken,onSubmit:a(c=>i("openaiToken",c),"onSubmit"),placeholder:"Input OpenAI token..."}),defaultValue:r("openaiToken"),key:"openaiToken",label:"OpenAI token",showValue:!1,value:n.openaiToken},{children:f(V,{defaultValue:n.apiBaseUrl,onSubmit:a(c=>i("apiBaseUrl",c),"onSubmit"),placeholder:"Set openAI API proxy, default value: https://api.openai.com/v1/..."}),defaultValue:r("apiBaseUrl"),desc:"OpenAI API proxy, default value: https://api.openai.com/v1/",key:"apiBaseUrl",label:"OpenAI API proxy",showValue:!1,value:n.apiBaseUrl}],[n]);return f(Tt,{active:e,items:s,logo:"\u{1F92F}",setActive:t,title:"Lobe I18N Config"})}),M=Q(({hide:e,filename:t,to:n,from:o,progress:r,maxStep:i,step:s,isLoading:c,needToken:l})=>{const m=vt();return e?null:L(Ct,{flexDirection:"column",children:[f(x,{backgroundColor:m.colorBgLayout,color:m.colorText,children:` \u{1F4DD} ${t} `}),L(x,{color:m.colorTextDescription,children:["- from ",f(x,{bold:!0,color:m.colorInfo,children:o})," to ",f(x,{bold:!0,color:m.colorInfo,children:n}),f(x,{color:m.colorTextDescription,children:` [Tokens: ${l}]`})]}),c?L(Kt,{children:[f(Lt,{label:` ${r}% [${s}/${i} chunks] `}),f(It,{value:r})]}):f(jt,{variant:"success",children:"Success"})]})}),Le=3,F=2,ut=2,h=a(e=>X(e).length,"calcToken"),C=a(e=>X(String(e)).length,"calcEncodedKeyToken"),pt=a(e=>C(e)+Le,"calcPrimitiveValueToken"),ft=a((e,t=0)=>Jt(Object.entries(e),([n,o])=>C(n)+F+(z(o)?ft(o,t+1):pt(o)))+ut+t,"calcJsonToken"),Ie=new Set([`
`,`\r
`,"[!NOTE]","[!IMPORTANT]","[!WARNING]","[!CAUTION]","\\[!NOTE]","\\[!IMPORTANT]","\\[!WARNING]","\\[!CAUTION]","\\[!NOTE]\\","\\[!IMPORTANT]\\","\\[!WARNING]\\","\\[!CAUTION]\\"]),je=a(e=>Ie.has(e)?!0:/^[\s\p{P}\u{1F300}-\u{1F5FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}]*$/u.test(e.replaceAll(" ","")),"checkMdString"),mt=a(async e=>tt().use(Gt).use(Z).use(H).parse(e.trim()),"convertMarkdownToMdast"),Ae=a((e,t)=>{const n={};let o=0;return et(e,t||"text",r=>{n[o]=r.value,o++}),n},"convertMdastToMdastObj"),Ee=a(e=>{const t={};for(const[n,o]of Object.entries(e))je(o)||(t[Number(n)]=o);return t},"pickMdastObj"),$e=a(({mdast:e,entry:t,target:n},o)=>{const r={...t,...n};let i=0;return et(e,o||"text",s=>{s.value=r[i],i++}),e},"mergeMdastObj"),B=a(async e=>tt().use(Vt,{bullet:"-",emphasis:"*",fences:!0,listItemIndent:1,rule:"-",strong:"*",tightDefinitions:!0}).use(H).use(Z).stringify(e),"convertMdastToMarkdown"),D=a((e,t)=>{const n=Qt(t,e),o=n.filter(c=>c.op==="add"),r=n.filter(c=>c.op==="remove"),i=Pt(t),s={};for(const c of r)Rt(i,c.path);for(const c of o)Ut(s,c.path,c.value);return{add:o,entry:s,remove:r,target:i}},"diff"),Je=a((e,t)=>Bt(Object.entries(e),(n,[o,r])=>{let[i,s]=n.pop()||[{},ut];const c=z(r)?ft(r,1):pt(r);return s+C(o)+F+c<=t?(i[o]=r,s+=C(o)+F+c,n.push([i,s])):n.push([i,s],[{[o]:r},C(o)+F+c]),n},[]).map(([n])=>n),"splitJSONtoSmallChunks"),dt=a((e,t)=>{let n=(we[e.modelName||ct]-h(t))/3;return n||(n=128e3),e.splitToken&&(n=e.splitToken),n=Math.floor(n),console.info("INFO: splitToken =",n),n},"getSplitToken"),Pe=a((e,t,n,o)=>{const r=D(t,n).entry,i=dt(e,o);return Je(r,i)},"splitJsonToChunks");let Re=class{static{a(this,"TranslateMarkdown")}mdast;entry={};config;check;definition;constructor(t){this.config=t,this.check=["text","yaml",t?.markdown?.translateCode&&"code"].filter(Boolean)}async genTarget(t){return this.mdast=await mt(t),this.entry=Ae(this.mdast,this.check),Ee(this.entry)}async genMarkdownByMdast(t){if(!t)return;const n=$e({entry:this.entry,mdast:this.mdast,target:t},this.check);return B(n)}async clearMarkdownString(t){const n=[],o=await mt(t);return o.children=o.children.map(r=>r.type==="definition"?(n.push(r),!1):r).filter(Boolean),{content:await B(o),definition:await B({children:n,type:"root"})}}async genSplitMarkdown(t,n){this.definition="";const{content:o,definition:r}=await this.clearMarkdownString(t);return this.definition=r,await qt.fromLanguage("markdown",{chunkOverlap:0,chunkSize:dt(this.config,n),lengthFunction:a(s=>h(s),"lengthFunction")}).splitText(o)}async genMarkdownByString(t){return[...t,this.definition].join(`

`)}};const Ue=a(e=>{let t={};for(const n of e)t=N(t,n);return t},"mergeJsonFromChunks"),gt="",Be=a((e=gt)=>nt.fromMessages([["system",["You are a translation expert.","Translate the i18n JSON file from {from} to {to}",e&&`Here are some reference to help with better translation.  ---${e}---`,"Keep the keys the same as the original file and make sure the output remains a valid i18n JSON file."].filter(Boolean).join(`
`)],["human",["{json}"].join(`
`)]]),"promptJsonTranslate"),De=a((e=gt)=>nt.fromMessages([["system",["You are a translation expert.","Translate the markdown from {from} to {to}.",e&&`Here are some reference to help with better translation.  ---${e}---`].filter(Boolean).join(`
`)],["human","{text}"]]),"promptStringTranslate"),_e=a(e=>{const t=a(n=>{switch(n){case"human":return"user";case"system":case"function":case"tool":return n;case"ai":case"generic":case"remove":default:return"assistant"}},"typeToRole");return e.map(n=>({role:t(n._getType()),content:n.content}))},"lcMsgs_2_oaiMsgs");let Ke=class{static{a(this,"TranslateLocale")}model;config;openAIProxyUrl;openAIApiKey;isJsonMode;promptJson;promptString;constructor(t,n,o){this.config=t,this.openAIProxyUrl=o,this.openAIApiKey=n,console.info("INFO: i18n config =",this.config),this.model=new zt({configuration:{baseURL:o},maxConcurrency:t.concurrency,maxRetries:4,modelName:t.modelName,openAIApiKey:n,temperature:t.temperature,topP:t.topP}),this.promptJson=Be(t.reference),this.promptString=De(t.reference),this.isJsonMode=!!this.config?.experimental?.jsonMode}async runByString({from:t,to:n,text:o}){try{const r=await this.promptString.formatMessages({from:t||this.config.entryLocale,text:o,to:n});let i="";const s=_e(r);return i=(await(await fetch(`${this.openAIProxyUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.openAIApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({messages:s,model:this.config.modelName,stream:!1,temperature:0})})).json()).choices[0].message.content,i||this.handleError(),i}catch(r){this.handleError(r)}}async runByJson({from:t,to:n,json:o}){try{const r=await this.promptJson.formatMessages({from:t||this.config.entryLocale,json:JSON.stringify(o),to:n}),i=await this.model.invoke(r,this.isJsonMode?{response_format:{type:"json_object"}}:void 0),s=this.isJsonMode?i.content:i.text;return s||this.handleError(),JSON.parse(s)}catch(r){this.handleError(r)}}handleError(t){g.error(`Translate failed, ${t||"please check your network or try again..."}`,!0),console.error("ERROR:",t)}};class ht{static{a(this,"I18n")}config;step=0;maxStep=1;translateLocaleService;translateMarkdownService;constructor({openAIApiKey:t,openAIProxyUrl:n,config:o}){this.config=o,this.translateLocaleService=new Ke(o,t,n),this.translateMarkdownService=new Re(o)}async translateMarkdown(t){return t.mode===v.STRING?this.translateMarkdownByString(t):this.translateMarkdownByMdast(t)}async translateMarkdownByString({md:t,to:n,onProgress:o,from:r}){const i=await this.translateLocaleService.promptString.formatMessages({from:r,text:"",to:n});console.info(`
INFO: translate markdown from ${r}: >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
`+t.substring(0,100),`
...
<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
`);const s=await this.translateMarkdownService.genSplitMarkdown(t,JSON.stringify(i));if(this.maxStep=s.length,this.step=0,s.length===0)return;const c=s.length*h(JSON.stringify(i))+h(JSON.stringify(s));o?.({isLoading:!0,maxStep:this.maxStep,needToken:c,progress:0,step:0}),console.info(`INFO: splitted into ${s.length} chunks based on splitToken
`);const l=await Y(s,async O=>{o?.({isLoading:this.step<this.maxStep,maxStep:this.maxStep,needToken:c,progress:this.step<this.maxStep?Math.floor(this.step/this.maxStep*100):100,step:this.step});const w=await this.translateLocaleService.runByString({from:r,text:O,to:n});return this.step<this.maxStep&&this.step++,console.info(`
--> translated to ${n}++++++++++++++++++++++++++++++++++++++++++++++
`+w.substring(0,100),`
...
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
`),w},{concurrency:this.config?.concurrency});return o?.({isLoading:!1,maxStep:this.maxStep,needToken:c,progress:100,step:this.maxStep}),{result:await this.translateMarkdownService.genMarkdownByString(l),tokenUsage:c+h(JSON.stringify(l))}}async translateMarkdownByMdast({md:t,...n}){const o=await this.translateMarkdownService.genTarget(t),r=await this.translate({...n,entry:o,target:{}});if(!r?.result)return;const i=await this.translateMarkdownService.genMarkdownByMdast(r);if(i)return{result:i,tokenUsage:r.tokenUsage}}async translate({entry:t,target:n,to:o,onProgress:r,from:i}){const s=await this.translateLocaleService.promptJson.formatMessages({from:i,json:{},to:o}),c=Pe(this.config,t,n,JSON.stringify(s));if(this.maxStep=c.length,this.step=0,c.length===0)return;const l=c.length*h(JSON.stringify(s))+h(JSON.stringify(c));r?.({isLoading:!0,maxStep:this.maxStep,needToken:l,progress:0,step:0});const m=await Y(c,async w=>{r?.({isLoading:this.step<this.maxStep,maxStep:this.maxStep,needToken:l,progress:this.step<this.maxStep?Math.floor(this.step/this.maxStep*100):100,step:this.step});const St=await this.translateLocaleService.runByJson({from:i,json:w,to:o});return this.step<this.maxStep&&this.step++,St},{concurrency:this.config?.concurrency});return r?.({isLoading:!1,maxStep:this.maxStep,needToken:l,progress:100,step:this.maxStep}),{result:await N(n,Ue(m)),tokenUsage:l+h(JSON.stringify(m))}}}const _=a(e=>{const t=rt(e,"utf8");return JSON.parse(t)},"readJSON"),S=a((e,t)=>{const n=Wt(t,{space:"  "});ot(e,n,"utf8")},"writeJSON"),qe=a(e=>rt(e,"utf8"),"readMarkdown"),Ge=a((e,t)=>{ot(e,t,"utf8")},"writeMarkdown"),Ve=a(e=>{for(const t of e.outputLocales){const n=y(e.output,`${t}.json`);T(n)||S(n,{})}},"checkLocales"),Qe=a((e,t)=>{for(const n of e.outputLocales){const o=y(e.output,n);T(o)||st(o)}for(const n of e.outputLocales)for(const o of t){const r=y(e.output,n,o);try{const i=_t(r);st(i,{recursive:!0})}catch{}T(r)||S(r,{})}},"checkLocaleFolders"),ze=a(e=>{try{const t=y("./",e.entry);return T(t)||g.error(`Can't find ${u.bold.yellow(e.entry)} in dir`,!0),_(t)}catch{Yt.exit(1)}},"getEntryFile"),We=a(e=>{const t=e.entry.replaceAll("*","").replaceAll("*.json",""),n=it(W(t,"**/*.json").replaceAll("\\","/"),{nodir:!0}),o={};for(const r of n)o[A(t,r)]=_(r);if(Object.keys(o).length===0){g.error(`Can't find .json files in ${u.bold.yellow(t)}`,!0);return}return o},"getEntryFolderFiles"),yt=a(e=>{const t=_(e);return t||(S(e,{}),{})},"getLocaleObj"),K=a((e,t)=>{try{if(e===t)return!0;if(typeof e!=typeof t)return!1;if(typeof e=="object"&&typeof t=="object"){const n=Object.keys(e),o=Object.keys(t);if(n.length!==o.length)return!1;for(const r of n)if(!o.includes(r)||!K(e[r],t[r]))return!1}return typeof e==typeof t}catch{return!1}},"isEqualJsonKeys");class Ye{static{a(this,"TranslateLocale")}config;query=[];i18n;constructor(){this.config=d.getLocaleConfig(),this.i18n=new ht({config:this.config,openAIApiKey:d.getOpenAIApiKey(),openAIProxyUrl:d.getOpenAIProxyUrl()})}async start(){p.start("Lobe I18N is analyzing your project... \u{1F92F}\u{1F30F}\u{1F50D}"),!this.config.entry.includes(".json")||this.config.entry.includes("*")?this.genFolderQuery():this.genFlatQuery(),this.query.length>0?await this.runQuery():p.success("No content requiring translation was found."),p.success("All i18n tasks have been completed\uFF01")}async runQuery(){p.info(`Current model setting: ${u.cyan(this.config.modelName)} (temperature: ${u.cyan(this.config.temperature)}) ${this.config.experimental?.jsonMode?u.red(" [JSON Mode]"):""}}`);let t=0;for(const n of this.query){const o={filename:n.filename,from:n.from||this.config.entryLocale,to:n.to},{rerender:r,clear:i}=I(f(M,{hide:!0,isLoading:!0,maxStep:1,progress:0,step:0,...o})),s=await this.i18n.translate({...n,onProgress:a(l=>{l.maxStep>0?r(f(M,{...l,...o})):i()},"onProgress")});i();const c=A(".",n.filename);s?.result&&Object.keys(s.result).length>0?(S(n.filename,s.result),t+=s.tokenUsage,p.success(u.yellow(c),u.gray(`[Token usage: ${s.tokenUsage}]`))):p.warn("No translation result was found:",u.yellow(c))}t>0&&p.info("Total token usage:",u.cyan(t))}genFolderQuery(){const t=this.config,n=We(t),o=Object.keys(n);p.info(`Running in ${u.bold.cyan("\u{1F4C2} Folder Mode")} and has found ${u.bold.cyan(o.length)} files.`),Qe(t,o);for(const r of t.outputLocales)for(const i of o){p.info(`${u.cyan(r)}${u.gray(" - ")}${u.yellow(i)}`);const s=y(t.output,r,i),c=n[i],l=D(c,yt(s)).target;S(s,l),!K(c,l)&&this.query.push({entry:c,filename:s,from:t.entryLocale,target:l,to:r})}}genFlatQuery(){const t=this.config,n=ze(t);p.start(`Running in ${u.bold.cyan("\u{1F4C4} Flat Mode")}, and translating ${u.bold.cyan(t.outputLocales.join("/"))} locales..`),Ve(t);for(const o of t.outputLocales){const r=y(t.output,o)+".json",i=n,s=D(i,yt(r)).target;S(r,s),!K(i,s)&&this.query.push({entry:i,filename:r,from:t.entryLocale,target:s,to:o})}}}const kt=a((e,t)=>e.map(n=>n.includes("*")||n.includes(t)?n:W(n,`**/*${t}`).replaceAll("\\","/")),"matchInputPattern");class wt{static{a(this,"TranslateMarkdown")}config;markdownConfig;query=[];i18n;constructor(){this.markdownConfig=d.getMarkdownConfigFile();const t=d.getConfigFile();this.config={...t,entryLocale:t.entryLocale||this.markdownConfig.entryLocale,markdown:this.markdownConfig,outputLocales:t.outputLocales||this.markdownConfig.outputLocales},this.i18n=new ht({config:this.config,openAIApiKey:d.getOpenAIApiKey(),openAIProxyUrl:d.getOpenAIProxyUrl()})}async start(){p.start("Lobe I18N is analyzing your markdown... \u{1F92F}\u{1F30F}\u{1F50D}");const t=this.markdownConfig.entry;(!t||t.length===0)&&g.error("No markdown entry was found.",!0);let n=it(kt(t,".md"),{ignore:this.markdownConfig.exclude?kt(this.markdownConfig.exclude||[],".md"):void 0,nodir:!0});this.markdownConfig.entryExtension&&(n=n.filter(o=>o.includes(this.markdownConfig.entryExtension||".md"))),(!n||n.length===0)&&g.error("No markdown entry was found.",!0),this.genFilesQuery(n),this.query.length>0?await this.runQuery():p.success("No content requiring translation was found."),p.success("All i18n tasks have been completed\uFF01")}async runQuery(){p.info(`Current model setting: ${u.cyan(this.config.modelName)} (temperature: ${u.cyan(this.config.temperature)}) ${this.config.experimental?.jsonMode?u.red(" [JSON Mode]"):""}}`);let t=0;for(const n of this.query){const o={filename:n.filename,from:n.from||this.markdownConfig.entryLocale||this.config.entryLocale,to:n.to},{rerender:r,clear:i}=I(f(M,{hide:!0,isLoading:!0,maxStep:1,progress:0,step:0,...o})),s=await this.i18n.translateMarkdown({...n,onProgress:a(l=>{l.maxStep>0?r(f(M,{...l,...o})):i()},"onProgress")});i();const c=A(".",n.filename);if(s?.result&&Object.keys(s.result).length>0){let l=s.result;this.markdownConfig.includeMatter||(l=at.stringify(s.result,n.matter)),Ge(n.filename,l),t+=s.tokenUsage,p.success(u.yellow(c),u.gray(`[Token usage: ${s.tokenUsage}]`))}else p.warn("No translation result was found:",u.yellow(c))}t>0&&p.info("Total token usage:",u.cyan(t))}genFilesQuery(t,n){const o=this.markdownConfig;n||p.start(`Running in ${u.bold.cyan(`\u{1F4C4} ${t.length} Markdown`)}, and translating to ${u.bold.cyan(o?.outputLocales?.join("/"))} locales..`);for(const r of t)try{const i=qe(r);for(const s of o.outputLocales||[]){const c=this.getTargetExtension(s,r,i),l=this.getTargetFilename(r,c);if(T(l))continue;const m=this.getMode(r,i),{data:O,content:w}=at(i);p.info(`\u{1F4C4} To ${s}: ${u.yellow(l)}`),this.query.push({filename:l,from:o.entryLocale,matter:O,md:this.markdownConfig.includeMatter?i:w,mode:m,to:s})}}catch{g.error(`${r} not found`,!0)}}getTargetExtension(t,n,o){return this.markdownConfig.outputExtensions?.(t,{fileContent:o,filePath:n,getDefaultExtension:$})||$(t)}getTargetFilename(t,n){if(this.markdownConfig.entryExtension)return y(".",t.replace(this.markdownConfig.entryExtension||".md",n));if(this.markdownConfig.entryLocale&&t.includes(`.${this.markdownConfig.entryLocale}.`))return[t.split(`.${this.markdownConfig.entryLocale}.`)[0],n].join("");{const o=t.split(".");return o.pop(),[o.join("."),n].join("")}}getMode(t,n){const o=this.markdownConfig.mode;return o?Dt(o)?o:o({fileContent:n,filePath:t})||v.STRING:v.STRING}}const Xe=Nt({pkg:E,shouldNotifyInNpmScript:!0});Xe.notify({isGlobal:!0});const b=new Ot;b.name("lobe-i18n").description(E.description).version(E.version).addOption(new j("-o, --option","Setup lobe-i18n preferences")).addOption(new j("-c, --config <string>","Specify the configuration file")).addOption(new j("-m, --with-md","Run i18n translation and markdown translation simultaneously")),b.command("locale",{isDefault:!0}).action(async()=>{const e=b.opts();e.option?I(f(Fe,{})):(e.config&&P.loadCustomConfig(e.config),await new Ye().start(),e.withMd&&await new wt().start())}),b.command("md").action(async()=>{const e=b.opts();e.config&&P.loadCustomConfig(e.config),await new wt().start()}),b.parse()});export default He();
